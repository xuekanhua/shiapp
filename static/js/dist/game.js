class ShiGameMenu{constructor(t){this.root=t,this.$menu=$('\n<div class="shi_game_menu">\n    <div class="shi_game_menu">\n        <div class="shi_game_menu_filed">\n            <div class="shi_game_menu_filed_item shi_game_menu_filed_item_single_mode">\n                    单人模式\n                </div>\n                <br>\n                <div class="shi_game_menu_filed_item shi_game_menu_filed_item_multi_mode">\n                    多人模式\n                </div>\n                <br>\n                <div class="shi_game_menu_filed_item shi_game_menu_filed_item_settings">\n                    退出\n                </div>\n        </div>\n    </div>\n</div>\n'),this.$menu.hide(),this.root.$shi_game.append(this.$menu),this.$single_mode=this.$menu.find(".shi_game_menu_filed_item_single_mode"),this.$multi_mode=this.$menu.find(".shi_game_menu_filed_item_multi_mode"),this.$settings=this.$menu.find(".shi_game_menu_filed_item_settings"),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$single_mode.click((function(){console.log("click single mode"),t.hide(),t.root.playground.show("single mode")})),this.$multi_mode.click((function(){console.log("click multi mode"),t.hide(),t.root.playground.show("multi mode")})),this.$settings.click((function(){console.log("click settings"),console.log("click logout"),t.root.settings.logout_on_remote()}))}show(){this.$menu.show()}hide(){this.$menu.hide()}}let last_timestamp,game_over=0,game_over_time=0,game_is_win=1,SHI_GAME_OBJECTS=[];class ShiGameObject{constructor(){SHI_GAME_OBJECTS.push(this),this.has_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let i=0;i<8;i++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){}update(){}late_update(){}on_destory(){}destory(){this.on_destory();for(let t=0;t<SHI_GAME_OBJECTS.length;t++)if(SHI_GAME_OBJECTS[t]===this){SHI_GAME_OBJECTS.splice(t,1);break}}}let SHI_GAME_ANIMATION=function(t){for(let i=0;i<SHI_GAME_OBJECTS.length;i++){let s=SHI_GAME_OBJECTS[i];s.has_called_start?(s.timedelta=t-last_timestamp,s.update()):(s.start(),s.has_called_start=!0)}for(let t=0;t<SHI_GAME_OBJECTS.length;t++){SHI_GAME_OBJECTS[t].late_update()}last_timestamp=t,1===game_over&&(game_over_time=t,game_over=-1),requestAnimationFrame(SHI_GAME_ANIMATION)};requestAnimationFrame(SHI_GAME_ANIMATION);class ChatField{constructor(t){this.playground=t,this.$history=$('<div class="shi_game_chat_field_history">历史记录</div>'),this.$input=$('<input type="text" class="shi_game_chat_field_input">'),this.$history.hide(),this.$input.hide(),this.func_id=null,this.playground.$playground.append(this.$history),this.playground.$playground.append(this.$input),this.start()}start(){this.add_listening_events()}render_message(t){return $(`<div>${t}</div>`)}add_message(t,i){this.show_history();let s=`[${t}] ${i}`;this.$history.append(this.render_message(s)),this.$history.scrollTop(this.$history[0].scrollHeight)}add_listening_events(){let t=this;this.$input.keydown((function(i){if(27===i.which)return t.hide_input(),!1;if(13===i.which){let i=t.playground.root.settings.username,s=t.$input.val();return s&&(t.$input.val(""),t.add_message(i,s),t.playground.mps.send_message(i,s)),!1}}))}show_history(){let t=this;this.$history.fadeIn(),this.func_id&&clearTimeout(this.func_id),this.func_id=setTimeout((function(){t.$history.fadeOut(),t.func_id=null}),3e3)}show_input(){this.show_history(),this.$input.show(),this.$input.focus()}hide_input(){this.$input.hide(),this.playground.game_map.$canvas.focus()}}class Grid extends ShiGameObject{constructor(t,i,s,e,h,a){super(),this.playground=t,this.ctx=i,this.i=s,this.j=e,this.l=h,this.boder=a,this.x=this.i*this.l,this.y=this.j*this.l,this.stroke_color="rgba(0, 0, 0, 0.1)",!1===this.boder&&(this.stroke_color="black")}start(){}update(){this.render()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy,e=i+.5*this.l,h=s+.5*this.l;!0===this.boder&&(e*t<-.2*this.playground.width||e*t>1.2*this.playground.width||h*t<-.2*this.playground.height||h*t>1.2*this.playground.height)||(this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=.03*this.l*t,!1===this.boder&&(this.ctx.lineWidth=.03*this.l*t*.02),this.ctx.strokeStyle=this.stroke_color,this.ctx.rect(i*t,s*t,this.l*t,this.l*t),this.ctx.stroke(),this.ctx.restore())}}class GameMap extends ShiGameObject{constructor(t){super(),this.playground=t,this.$canvas=$('<canvas tabindex=0 class="shi_game_playground_game_map"></canvas>'),this.ctx=this.$canvas[0].getContext("2d"),this.width=this.playground.width,this.height=this.playground.height,this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.playground.$playground.append(this.$canvas),this.generate_grid(),this.start()}start(){this.$canvas.focus()}generate_grid(){let t=this.playground.virtual_map_width,i=this.playground.virtual_map_height,s=i,e=Math.ceil(t/s),h=Math.ceil(i/s);this.grids=[];for(let t=0;t<h;t++)for(let i=0;i<e;i++)this.grids.push(new Grid(this.playground,this.ctx,i,t,s,!1));s=.025*i,e=Math.ceil(t/s),h=Math.ceil(i/s);for(let t=0;t<h;t++)for(let i=0;i<e;i++)this.grids.push(new Grid(this.playground,this.ctx,i,t,s,!0))}update(){this.render()}resize(){this.ctx.canvas.width=this.playground.map_width,this.ctx.canvas.height=this.playground.map_height,this.ctx.fillStyle="rgba(176,224,230, 1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}render(){this.ctx.fillStyle="rgba(176,224,230, 0.6)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class MiniMap extends ShiGameObject{constructor(t){super(),this.playground=t,this.$canvas=$('<canvas class="mini-map"></canvas>'),this.ctx=this.$canvas[0].getContext("2d"),this.bg_color="rgba(0, 0, 0, 0.3)",this.bright_color="rgba(247, 232, 200, 0.7)",this.players=this.playground.players,this.pos_x=this.playground.width-.3*this.playground.height,this.pos_y=.7*this.playground.height,this.width=.3*this.playground.height,this.height=this.width,this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.playground.$playground.append(this.$canvas),this.real_map_width=this.playground.virtual_map_width,this.lock=!1,this.drag=!1}start(){this.add_listening_events()}resize(){this.pos_x=this.playground.width-.3*this.playground.height,this.pos_y=.7*this.playground.height,this.width=.3*this.playground.height,this.height=this.width,this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.margin_right=(this.playground.$playground.width()-this.playground.width)/2,this.margin_bottom=(this.playground.$playground.height()-this.playground.height)/2,this.$canvas.css({position:"absolute",right:this.margin_right,bottom:this.margin_bottom})}add_listening_events(){let t=this;this.$canvas.on("contextmenu",(function(){return!1})),this.$canvas.mousedown((function(i){const s=t.ctx.canvas.getBoundingClientRect();let e=i.clientX-s.left,h=i.clientY-s.top,a=e/t.width*t.playground.virtual_map_width,n=h/t.height*t.playground.virtual_map_height;if(1===i.which)t.lock=!0,t.drag=!1,t.playground.focus_player=null,t.playground.re_calculate_cx_cy(a,n),t.rect_x1=e-t.playground.width/2/t.playground.scale/t.playground.virtual_map_width*t.width,t.rect_y1=h-t.playground.height/2/t.playground.scale/t.playground.virtual_map_height*t.height;else if(3===i.which){let i=t.playground.players[0];"me"===i.character&&i.move_to(a,n)}})),this.$canvas.mousemove((function(i){const s=t.ctx.canvas.getBoundingClientRect();let e=i.clientX-s.left,h=i.clientY-s.top,a=e/t.width*t.playground.virtual_map_width,n=h/t.height*t.playground.virtual_map_height;1===i.which&&t.lock&&(t.drag=!0,t.playground.focus_player=null,t.playground.re_calculate_cx_cy(a,n),t.rect_x1=e-t.playground.width/2/t.playground.scale/t.playground.virtual_map_width*t.width,t.rect_y1=h-t.playground.height/2/t.playground.scale/t.playground.virtual_map_height*t.height)})),this.$canvas.mouseup((function(i){t.lock&&(t.lock=!1)}))}update(){this.render()}render(){let t=this.playground.scale;this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle=this.bg_color,this.ctx.fillRect(0,0,this.width,this.height),this.playground.focus_player&&(this.rect_x1=(this.playground.focus_player.x-this.playground.width/2/t)/this.real_map_width*this.width,this.rect_y1=(this.playground.focus_player.y-this.playground.height/2/t)/this.real_map_width*this.height);let i=this.playground.width/t/this.real_map_width*this.width,s=this.playground.height/t/this.real_map_width*this.height;this.ctx.save(),this.ctx.strokeStyle=this.bright_color,this.ctx.setLineDash([15,5]),this.ctx.lineWidth=Math.ceil(3*t/1080),this.ctx.strokeRect(this.rect_x1,this.rect_y1,i,s),this.ctx.restore();for(let t=0;t<this.players.length;t++){let i=this.players[t],s=i.x/this.real_map_width*this.width,e=i.y/this.real_map_width*this.height;this.ctx.beginPath(),this.ctx.arc(s,e,.04*this.width,0,2*Math.PI,!1),"me"===i.character?this.ctx.fillStyle="green":this.ctx.fillStyle="red",this.ctx.fill()}}}class NoticeBoard extends ShiGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.text="已就绪：0人"}start(){}write(t){this.text=t}update(){this.render()}render(){this.ctx.font="20px serif",this.ctx.fillStyle="black",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.playground.width/2,20)}}class Particle extends ShiGameObject{constructor(t,i,s,e,h,a,n,l,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s,this.radius=e,this.vx=h,this.vy=a,this.color=n,this.speed=l,this.friction=.9,this.move_length=r,this.eps=.01}start(){}update(){if(this.move_length<this.eps||this.speed<this.eps)return this.destory(),!1;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.speed*=this.friction,this.move_length-=t,this.render()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.1*this.playground.width/t||i>1.1*this.playground.width/t||s<-.1*this.playground.height/t||s>1.1*this.playground.height/t||(this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class Player extends ShiGameObject{constructor(t,i,s,e,h,a,n,l,r,o){console.log(n,l,r),super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.y=s,this.x=i,this.vx=0,this.vy=0,this.damage_x=0,this.damage_y=0,this.damage_speed=0,this.radius=e,this.color=h,this.move_length=0,this.speed=a,this.character=n,l=l,this.photo=r,this.user_mode=o,this.eps=.01,this.friction=.9,this.spent_time=0,this.cur_skill=null,this.speed_old=this.speed,this.fireballs=[],"robot"!==this.character?(this.img=new Image,this.img.src=this.photo):(this.img=new Image,this.img.src="https://app171.acapp.acwing.com.cn/static/image/playground/huaidan.png"),console.log(this.user_mode),"me"===this.character?(this.fireball_coldtime=3,this.fireball_img=new Image,this.fireball_img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png",this.blink_coldtime=5,this.blink_img=new Image,this.blink_img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png"):"robot"===this.character&&(this.fireball_coldtime=3)}start(){if(this.playground.player_count++,this.playground.notice_board.write("已就绪："+this.playground.player_count+"/3    再等等嘛🥰"),this.playground.player_count>=3&&(this.playground.state="fighting",this.playground.notice_board.write("Fighting  存活人数："+this.playground.player_count+"   你要加油呀🥰")),"me"===this.character)this.add_listening_events();else if("robot"===this.character){let t=Math.random()*this.playground.virtual_map_width,i=Math.random()*this.playground.virtual_map_height;this.move_to(t,i)}}add_listening_events(){let t,i,s=this;this.playground.game_map.$canvas.mousemove((function(s){t=s.clientX,i=s.clientY})),this.playground.game_map.$canvas.mousedown((function(s){t=s.clientX,i=s.clientY})),this.playground.game_map.$canvas.on("contextmenu",(function(){return!1})),this.playground.game_map.$canvas.mousedown((function(t){if("fighting"!==s.playground.state)return!0;const i=s.ctx.canvas.getBoundingClientRect();let e=(t.clientX-i.left)/s.playground.scale+s.playground.cx,h=(t.clientY-i.top)/s.playground.scale+s.playground.cy;if(3===t.which){if(e<0||e>s.playground.virtual_map_width||h<0||h>s.playground.virtual_map_height)return;s.move_to(e,h),"multi mode"===s.playground.mode&&s.playground.mps.send_move_to(e,h)}else if(1===t.which){if("fireball"===s.cur_skill){if(s.fireball_coldtime>s.eps)return!1;let t=s.shoot_fireball(e,h);s.fireball_coldtime=0,"multi mode"===s.playground.mode&&s.playground.mps.send_shoot_fireball(e,h,t.uuid)}else if("blink"===s.cur_skill){if(s.blink_coldtime>s.eps)return!1;s.blink(e,h),s.cur_skill=null,s.blink_coldtime=5,"multi mode"===s.playground.mode&&s.playground.mps.send_blink(e,h)}s.cur_skill=null}})),this.playground.game_map.$canvas.keydown((function(t){if(13===t.which){if(console.log(SHI_GAME_OBJECTS),"multi mode"===s.playground.mode)return s.playground.chat_field.show_input(),!1}else 27===t.which&&"multi mode"===s.playground.mode&&s.playground.chat_field.hide_input();if("fighting"!==s.playground.state)return!0;s.ctx.canvas.getBoundingClientRect();return 32===t.which||49===t.which?(s.playground.focus_player=s,s.playground.re_calculate_cx_cy(s.x,s.y),!1):81===t.which?s.fireball_coldtime>s.eps||(s.cur_skill="fireball",!1):69===t.which?(s.cur_skill="zisha",s.is_attacked(0,.005),s.cur_skill=null,!1):70===t.which?s.blink_coldtime>s.eps||(s.cur_skill="blink",!1):void 0}))}shoot_fireball(t,i){let s=this.x,e=this.y,h=Math.atan2(i-this.y,t-this.x),a=Math.cos(h),n=Math.sin(h),l=new FireBall(this.playground,this,s,e,.01,a,n,"orange",.5,1,.01*.9);return this.fireballs.push(l),l}blink(t,i){let s=this.get_dist(this.x,this.y,t,i);s=Math.min(s,.8);let e=Math.atan2(i-this.y,t-this.x);this.x+=s*Math.cos(e),this.y+=s*Math.sin(e),this.move_length=0}get_dist(t,i,s,e){let h=t-s,a=i-e;return Math.sqrt(h*h+a*a)}move_to(t,i){let s=this;if("me"===this.character)for(let e=0;e<10+10*Math.random();e++){let e=s.radius*Math.random()*.08,h=Math.random()*Math.PI*2,a=Math.cos(h),n=Math.sin(h),l=(s.color,.15*s.speed*5),r=s.radius*Math.random()*2;new Particle(s.playground,t,i,e,a,n,"green",l,r)}this.move_length=this.get_dist(this.x,this.y,t,i);let e=Math.atan2(i-this.y,t-this.x);this.vx=Math.cos(e),this.vy=Math.sin(e)}is_attacked(t,i){for(let t=0;t<20+5*Math.random();t++){let t=this.x,i=this.y,s=this.radius*Math.random()*.09,e=Math.random()*Math.PI*2,h=Math.cos(e),a=Math.sin(e),n=this.color,l=15*this.speed/3,r=this.radius*Math.random()*5;new Particle(this.playground,t,i,s,h,a,n,l,r)}if(this.radius-=i,this.radius<this.eps)return this.destory(),!1;this.dangeg_x=Math.cos(t),this.damage_y=Math.sin(t),this.damage_speed=100*i,this.speed*=1.1}re_calculate_cx_cy(){this.playground.cx=this.x-.5*this.playground.width/this.playground.scale,this.playground.cy=this.y-.5*this.playground.height/this.playground.scale}receive_attacked(t,i,s,e,h,a){a.destory_fireball(h),this.x=t,this.y=i,this.is_attacked(s,e)}update(){this.spent_time+=this.timedelta/1e3,this.update_move(),this.user_mode,"me"===this.character&&"fighting"===this.playground.state&&this.update_coldtime(),"me"===this.character&&this.playground.focus_player===this&&this.playground.re_calculate_cx_cy(this.x,this.y),this.render()}update_coldtime(){this.fireball_coldtime-=this.timedelta/1e3,this.fireball_coldtime=Math.max(0,this.fireball_coldtime),this.blink_coldtime-=this.timedelta/1e3,this.blink_coldtime=Math.max(0,this.blink_coldtime)}update_move(){if(Math.random()<.004&&"robot"===this.character&&this.spent_time>4){let t=this.playground.players[Math.floor(Math.random()*this.playground.players.length)],i=t.x+t.speed*this.vx*this.timedelta/1e3*1,s=t.y+t.speed*this.vy*this.timedelta/1e3*1;t!==this&&this.shoot_fireball(i,s)}if(this.damage_speed>this.eps)this.vx=0,this.vy=0,this.move_length=0,this.x+=this.damage_x*this.damage_speed*this.timedelta/1e3,this.y+=this.damage_y*this.damage_speed*this.timedelta/1e3,this.damage_speed*=this.friction;else if(this.move_length<this.eps){if(this.move_length=0,this.vx=this.vy=0,"robot"===this.character){let t=Math.random()*this.playground.virtual_map_width,i=Math.random()*this.playground.virtual_map_height;this.move_to(t,i)}}else{this.speed=2*this.speed_old;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}}update_single_gameover(){if(last_timestamp-game_over_time>=500&&-1===game_over)return game_over=0,console.log(game_is_win),-1===game_is_win?!!confirm("你输了,接下来是否返回主菜单？")&&(location.reload(),!0):1===game_is_win?!!confirm("恭喜胜利，接下来是否返回主菜单？")&&(location.reload(),!0):!!confirm("游戏结束，接下来是否返回主菜单？")&&(location.reload(),!0)}destory_fireball(t){for(let i=0;i<this.fireballs.length;i++){let s=this.fireballs[i];if(s.uuid===t){s.destory();break}}}on_destory(){this.playground.player_count--,"fighting"===this.playground.state&&(this.playground.notice_board.write("Fighting  存活人数："+this.playground.player_count+"   你要加油呀🥰"),1===this.playground.player_count&&(this.playground.notice_board.write("🎉🎉✨✨恭喜你取得最终胜利✨✨🎉🎉"),this.playground.score_board.win())),"me"===this.character&&(this.playground.state="over",this.playground.notice_board.write("🐽铸币吧，好菜呀🐽"),this.playground.score_board.lose());for(let t=0;t<this.playground.players.length;t++)if(this.playground.players[t]===this){"me"===this.character&&(game_is_win=-1,game_over=1),this.playground.players.splice(t,1);break}1===this.playground.players.length&&"single"===this.playground.players[0].user_mode&&(game_over=1)}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.2*this.playground.width/t||i>1.2*this.playground.width/t||s<-.2*this.playground.height/t||s>1.2*this.playground.height/t||(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(i-this.radius)*t,(s-this.radius)*t,2*this.radius*t,2*this.radius*t),this.ctx.restore(),"me"===this.character&&"fighting"===this.playground.state&&this.render_skill_clodtime())}render_skill_clodtime(){let t=this.playground.scale,i=.8,s=.9,e=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.fireball_img,.76*t,.86*t,.08*t,.08*t),this.ctx.restore();let h=.62+.3,a=.9,n=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(h*t,a*t,n*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.blink_img,(h-n)*t,.86*t,.08*t,.08*t),this.ctx.restore(),this.fireball_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,s*t),this.ctx.arc(i*t,s*t,e*t,0-Math.PI/2,2*Math.PI*(1-this.fireball_coldtime/3)-Math.PI/2,!0),this.ctx.lineTo(i*t,s*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.5)",this.ctx.fill()),this.blink_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(h*t,a*t),this.ctx.arc(h*t,a*t,n*t,0-Math.PI/2,2*Math.PI*(1-this.blink_coldtime/5)-Math.PI/2,!0),this.ctx.lineTo(h*t,a*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.5)",this.ctx.fill())}}class ScoreBoard extends ShiGameObject{constructor(t){super(),console.log("ss"),this.playground=t,this.ctx=this.playground.game_map.ctx,this.state=null,this.win_img=new Image,this.win_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png",this.lose_img=new Image,this.lose_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png"}start(){console.log(this.state)}add_listening_events(){let t=this;this.playground.game_map.$canvas.on("click",(function(){this.state=null,t.playground.hide(),t.playground.root.menu.show(),location.reload()}))}win(){this.state="win";let t=this;setTimeout((function(){t.add_listening_events(),t.playground.notice_board.write("单击退出")}),3e3)}lose(){this.state="lose";let t=this;setTimeout((function(){t.add_listening_events(),t.playground.notice_board.write("单击退出")}),3e3)}late_update(){this.render()}render(){let t=this.playground.height/2;"win"===this.state?this.ctx.drawImage(this.win_img,this.playground.width/2-t/2,this.playground.height/2-t/2,t,t):"lose"===this.state&&this.ctx.drawImage(this.lose_img,this.playground.width/2-t/2,this.playground.height/2-t/2,t,t)}}class FireBall extends ShiGameObject{constructor(t,i,s,e,h,a,n,l,r,o,d){super(),this.playground=t,this.player=i,this.ctx=this.playground.game_map.ctx,this.y=e,this.x=s,this.move_length=o,this.vx=a,this.vy=n,this.radius=h,this.color=l,this.speed=r,this.damage=d,this.eps=.01}start(){}update(){this.update_over(),this.update_move(),"enemy"!==this.player.character&&this.update_attack(),this.render()}update_over(){if(this.move_length<this.eps)return this.destory(),!1}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);t*=1.5,this.player.is_me&&(t*=2),this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];if(this.player!==i&&this.is_collision(i)){this.attack(i);break}}}get_dist(t,i,s,e){let h=t-s,a=i-e;return Math.sqrt(h*h+a*a)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}attack(t){let i=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(i,this.damage),"multi mode"===this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,i,this.damage,this.uuid),this.destory()}on_destory(){let t=this.player.fireballs;for(let i=0;i<t.length;i++)if(t[i]===this){t.splice(i,1);break}}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.1*this.playground.width/t||i>1.1*this.playground.width/t||s<-.1*this.playground.height/t||s>1.1*this.playground.height/t||(this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class MultiPlayerSocket{constructor(t){this.playground=t,this.ws=new WebSocket("wss://app171.acapp.acwing.com.cn/wss/multiplayer/"),this.start()}start(){this.receive()}receive(){let t=this;this.ws.onmessage=function(i){let s=JSON.parse(i.data),e=s.uuid;if(e===t.uuid)return!1;let h=s.event;"create_player"===h?t.receive_create_player(e,s.username,s.photo):"move_to"===h?t.receive_move_to(e,s.tx,s.ty):"shoot_fireball"===h?t.receive_shoot_fireball(s.uuid,s.tx,s.ty,s.ball_uuid):"attack"===h?t.receive_attack(e,s.attackee_uuid,s.x,s.y,s.angle,s.damage,s.ball_uuid):"blink"===h?t.receive_blink(e,s.tx,s.ty):"message"===h&&t.receive_message(e,s.username,s.text)}}send_create_player(t,i){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:t,photo:i}))}receive_create_player(t,i,s){let e=new Player(this.playground,this.playground.width/2/this.playground.scale,.5,.05,"white",.15,"enemy",i,s,"multi");e.uuid=t,this.playground.players.push(e)}get_player(t){let i=this.playground.players;for(let s=0;s<i.length;s++){let e=i[s];if(e.uuid===t)return e}return null}send_move_to(t,i){this.ws.send(JSON.stringify({event:"move_to",uuid:this.uuid,tx:t,ty:i}))}receive_move_to(t,i,s){let e=this.get_player(t);e&&e.move_to(i,s)}send_shoot_fireball(t,i,s){this.ws.send(JSON.stringify({event:"shoot_fireball",uuid:this.uuid,tx:t,ty:i,ball_uuid:s}))}receive_shoot_fireball(t,i,s,e){let h=this.get_player(t);if(h){h.shoot_fireball(i,s).uuid=e}}send_attack(t,i,s,e,h,a){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:t,x:i,y:s,angle:e,damage:h,ball_uuid:a}))}receive_attack(t,i,s,e,h,a,n){let l=this.get_player(t),r=this.get_player(i);l&&r&&r.receive_attacked(s,e,h,a,n,l)}send_blink(t,i){this.ws.send(JSON.stringify({event:"blink",uuid:this.uuid,tx:t,ty:i}))}receive_blink(t,i,s){let e=this.get_player(t);e&&e.blink(i,s)}send_message(t,i){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,username:t,text:i}))}receive_message(t,i,s){this.playground.chat_field.add_message(i,s)}}class ShiGamePlayground{constructor(t){this.root=t,this.focus_player=null,this.$playground=$('\n        <div class="shi_game_playground">  </div>\n        '),this.hide(),this.start()}get_random_color(){return["blue","red","pink","grey","green"][Math.floor(5*Math.random())]}create_uuid(){let t="";for(let i=0;i<8;i++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){let t=this,i=this.create_uuid();$(window).on(`resize.${i}`,(function(){t.resize()})),this.root.AcWingOS&&this.root.AcWingOS.api.window.on_close((function(){$(window).off(`resize.${i}`)}))}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let t=Math.min(this.width/16,this.height/9);this.width=16*t,this.height=9*t,this.map_width=2*t*16/2,this.map_height=2*t*9/2,this.scale=this.height,this.game_map&&this.game_map.resize(),this.mini_map&&this.mini_map.resize()}re_calculate_cx_cy(t,i){this.cx=t-.5*this.width/this.scale,this.cy=i-.5*this.height/this.scale}show(t){let i=this;if(this.$playground.show(),this.root.$shi_game.append(this.$playground),this.resize(),this.virtual_map_width=3,this.virtual_map_height=this.virtual_map_width,this.game_map=new GameMap(this),this.resize(),this.mode=t,this.state="waiting",this.players=[],this.notice_board=new NoticeBoard(this),this.player_count=0,this.score_board=new ScoreBoard(this),"single mode"===t){this.players.push(new Player(this,this.width/2/this.scale,.5,.05,"white",.15,"me",this.root.settings.username,this.root.settings.photo,"single")),this.re_calculate_cx_cy(this.players[0].x,this.players[0].y),this.focus_player=this.players[0];for(let t=0;t<5;t++)this.players.push(new Player(this,this.width/2/this.scale,.5,.05,"black",.15,"robot","","","single"))}else"multi mode"===t&&(this.chat_field=new ChatField(this),this.players.push(new Player(this,this.width/2/this.scale,.5,.05,"white",.15,"me",this.root.settings.username,this.root.settings.photo,"multi")),this.re_calculate_cx_cy(this.players[0].x,this.players[0].y),this.focus_player=this.players[0],this.mps=new MultiPlayerSocket(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=function(){i.mps.send_create_player(i.root.settings.username,i.root.settings.photo)});this.mini_map=new MiniMap(this,this.game_map),this.mini_map.resize()}hide(){for(;this.players&&this.players.length>0;)this.players[0].destory();this.game_map&&(this.game_map.destory(),this.game_map=null),this.notice_board&&(this.notice_board.destory(),this.notice_board=null),this.score_board&&(this.score_board.destory(),this.score_board=null,console.log("12344")),this.$playground.empty(),this.$playground.hide()}}class Settings{constructor(t){this.root=t,this.platform="WEB",this.root.AcWingOS&&(this.platform="ACAPP"),console.log(this.platform),this.username="",this.photo="",this.$settings=$('\n<div class="shi_game_settings">\n\n    <div class="shi_game_settings_login">\n\n        <div class="shi_game_settings_title">\n            登录\n        </div>\n                \n        <div class="shi_game_settings_username">\n            <div class="shi_game_settings_item">\n                <input type="text" placeholder="用户名" >\n            </div>\n        </div>\n\n        <div class="shi_game_settings_password">\n            <div class="shi_game_settings_item">\n                <input type="password" placeholder="密码" >\n            </div>\n        </div>\n\n        <div class="shi_game_settings_submit">\n            <div class="shi_game_settings_item">\n                <button>登录</button>\n            </div>\n        </div>\n\n        <div class="shi_game_settings_error_messages">\n            \n        </div>\n        <div class="shi_game_settings_option">\n            注册\n        </div>\n\n        <br>\n        <br>\n        <br>\n\n        <div class="shi_game_settings_quick_login">\n            <div class="shi_game_settings_quick_acwing">\n                <img width="30" src="/static/image/settings/acwing_logo.png">\n                <br>\n                <div>\n                    AcWing登录\n                </div>\n            </div>\n            <div class="shi_game_settings_quick_gitee">\n                <img width="30" src="https://cdn.acwing.com/media/article/image/2021/12/02/137551_c53a0bc853-META-INF_pluginIcon.png">\n                <br>\n                <div>\n                    Gitee登录\n                </div>\n            </div>\n            <div class="shi_game_settings_quick_github">\n                <img width="30" src="https://cdn.jsdelivr.net/gh/zhangying458/CDN/nav/chapter/axvol-1j3rc.webp">\n                <br>\n                <div>\n                    GitHub登录\n                </div>\n            </div>\n        </div>\n        \n\n    </div>\n\n\n    <div class="shi_game_settings_register">\n        <div class="shi_game_settings_title">\n            注册\n        </div>\n            \n        <div class="shi_game_settings_username">\n            <div class="shi_game_settings_item">\n                <input type="text" placeholder="用户名" >\n            </div>\n        </div>\n\n        <div class="shi_game_settings_password shi_game_settings_password_first ">\n            <div class="shi_game_settings_item">\n                <input type="password" placeholder="密码" >\n            </div>\n        </div>\n\n        <div class="shi_game_settings_password shi_game_settings_password_second">\n            <div class="shi_game_settings_item">\n                <input type="password" placeholder="确认密码" >\n            </div>\n        </div>\n\n        <div class="shi_game_settings_photo">\n            <div class="shi_game_settings_item">\n                <input type="text" placeholder="头像链接(默认可不填)" >\n            </div>\n        </div>\n\n        <div class="shi_game_settings_submit">\n            <div class="shi_game_settings_item">\n                <button>注册</button>\n            </div>\n        </div>\n\n        <div class="shi_game_settings_error_messages">\n            \n        </div>\n        <div class="shi_game_settings_option">\n            登录\n        </div>\n\n        <br>\n        <div class="shi_game_settings_quick_login">\n            <div class="shi_game_settings_quick_acwing">\n                <img width="30" src="/static/image/settings/acwing_logo.png">\n                <br>\n                <div>\n                    AcWing登录\n                </div>\n            </div>\n            <div class="shi_game_settings_quick_gitee">\n                <img width="30" src="https://cdn.acwing.com/media/article/image/2021/12/02/137551_c53a0bc853-META-INF_pluginIcon.png">\n                <br>\n                <div>\n                    Gitee登录\n                </div>\n            </div>\n            <div class="shi_game_settings_quick_github">\n                <img width="30" src="https://cdn.jsdelivr.net/gh/zhangying458/CDN/nav/chapter/axvol-1j3rc.webp">\n                <br>\n                <div>\n                    GitHub登录\n                </div>\n            </div>\n        </div>\n\n    </div>\n\n</div>\n'),this.$login=this.$settings.find(".shi_game_settings_login"),this.$login_username=this.$login.find(".shi_game_settings_username input"),this.$login_password=this.$login.find(".shi_game_settings_password input"),this.$login_submit=this.$login.find(".shi_game_settings_submit button"),this.$login_error_messages=this.$login.find(".shi_game_settings_error_messages"),this.$login_register=this.$login.find(".shi_game_settings_option"),this.$login.hide(),this.$register=this.$settings.find(".shi_game_settings_register"),this.$register_username=this.$register.find(".shi_game_settings_username input"),this.$register_password=this.$register.find(".shi_game_settings_password_first input"),this.$register_password_confirm=this.$register.find(".shi_game_settings_password_second input"),this.$register_photo=this.$register.find(".shi_game_settings_photo input"),this.$register_submit=this.$register.find(".shi_game_settings_submit button"),this.$register_error_messages=this.$register.find(".shi_game_settings_error_messages"),this.$register_login=this.$register.find(".shi_game_settings_option"),this.$register.hide(),this.$acwing_login=this.$settings.find(".shi_game_settings_quick_acwing img"),this.$gitee_login=this.$settings.find(".shi_game_settings_quick_gitee img"),this.$github_login=this.$settings.find(".shi_game_settings_quick_github img"),this.root.$shi_game.append(this.$settings),this.start()}add_listening_events(){let t=this;this.add_listening_events_login(),this.add_listening_events_register(),this.$acwing_login.click((function(){console.log("yes"),t.acwing_login()})),this.$gitee_login.click((function(){console.log("yes"),t.gitee_login()})),this.$github_login.click((function(){console.log("yes"),t.github_login()}))}add_listening_events_login(){let t=this;this.$login_register.click((function(){t.register()})),this.$login_submit.click((function(){t.login_on_remote()}))}add_listening_events_register(){let t=this;this.$register_login.click((function(){t.login()})),this.$register_submit.click((function(){t.register_on_remote()}))}acwing_login(){console.log("acwing_click login"),$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/acwing/web/apply_code/",type:"GET",success:function(t){"success"===t.result&&(console.log(t.apply_code_url),window.location.replace(t.apply_code_url))}})}gitee_login(){console.log("gitee_click login"),$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/gitee/apply_code/",type:"GET",success:function(t){"success"===t.result&&(console.log(t.apply_code_url),window.location.replace(t.apply_code_url))}})}github_login(){console.log("gitee_click login"),$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/github/apply_code/",type:"GET",success:function(t){"success"===t.result&&console.log(t.apply_code_url)}})}start(){"ACAPP"===this.platform?(console.log("login_acapp"),this.getinfo_acapp()):(console.log("login_web"),this.getinfo_web(),this.add_listening_events())}login_on_remote(){let t=this,i=this.$login_username.val(),s=this.$login_password.val();this.$login_error_messages.empty(),$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/login/",type:"GET",data:{username:i,password:s},success:function(i){console.log(i),"success"===i.result?location.reload():t.$login_error_messages.html(i.result)}})}register_on_remote(){let t=this,i=this.$register_username.val(),s=this.$register_password.val(),e=this.$register_password_confirm.val(),h=this.$register_photo.val();this.$register_error_messages.empty(),$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/register",type:"GET",data:{username:i,password:s,password_confirm:e,photo:h},success:function(i){console.log(i),console.log(i.result),"success"===i.result?location.reload():t.$register_error_messages.html(i.result)}})}logout_on_remote(){if("SHIAPP"===this.platform)return!1;$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/logout/",type:"GET",success:function(t){console.log(t),"success"!==t.result&&"success_not"!==t.result||location.reload()}})}register(){this.$login.hide(),this.$register.show()}login(){this.$register.hide(),this.$login.show()}acapp_login(t,i,s,e){let h=this;this.root.AcWingOS.api.oauth2.authorize(t,i,s,e,(function(t){console.log("called from acapp_login function"),console.log(t.result),console.log(t),"success"===t.result&&(h.username=t.username,h.photo=t.photo,h.hide(),h.root.menu.show())}))}getinfo_acapp(){let t=this;$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/",type:"GET",success:function(i){"success"===i.result&&t.acapp_login(i.appid,i.redirect_uri,i.scope,i.state)}})}getinfo_web(){let t=this;$.ajax({url:"https://app171.acapp.acwing.com.cn/settings/getinfo/",type:"GET",data:{platform:t.platform},success:function(i){console.log(i),"success"===i.result?(t.username=i.username,t.photo=i.photo,t.hide(),t.root.menu.show()):t.login()}})}hide(){this.$settings.hide()}show(){this.$settings.show()}}export class ShiGame{constructor(t,i){console.log(i),this.id=t,this.$shi_game=$("#"+t),this.AcWingOS=i,this.settings=new Settings(this),this.menu=new ShiGameMenu(this),this.playground=new ShiGamePlayground(this),this.start()}start(){console.log("start")}}
